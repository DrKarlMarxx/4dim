{% extends 'devices/base.html' %}

{% load staticfiles %}

{% block body_block %}


<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
  <a class="navbar-brand" href="#">4dim</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="collapsibleNavbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="#">Map</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">About</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container" style="margin-top:30px">
  <div class="row">
    <div class="col-sm-4">
      <h2>Current Air Quality</h2>
      <h5>Your Location:</h5>
      <p id="pName">Unknown location</p>
        <h5>Distance to next sensor:</h5>
      <p id="pDistance">Unknown Value</p>
      <h5>PM10-Value:</h5>
      <p id="pPM10Value">Unknown Value</p>
        <h5>PM2.5-Value:</h5>
      <p id="pPM25Value">Unknown Value</p>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item">
          <a class="nav-link" href="https://en.wikipedia.org/wiki/Particulates">Particulate Matter</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://en.wikipedia.org/wiki/Air_pollution">Air pollution</a>
        </li>
      </ul>
      <hr class="d-sm-none">
    </div>
    <div class="col-sm-8">
      <div id="mapid" class="my-4 w-100" style="height: 100%; width:100%"></div>

            <select id="sensor_value_selection" class="form-control"  onchange='loadHexbin(this)' onload='loadHexbin(this)'>
            {% for entry in value_type_list %}
                <option value="{{entry}}">{{entry}}</option>
            {% endfor %}
            </select>
            <canvas id="myChart" class="my-4 w-100"  width="1000" height="500"></canvas>
    </div>
  </div>
</div>






<script type="text/javascript">


        //L.mapbox.accessToken = 'pk.eyJ1IjoiZHJrYWxybWFyeHgiLCJhIjoiY2poeGl3NXc3MGI2dzNxcHV1eHh2OGh4ZyJ9.9VnqOY3kY8Rid8FUFb2Okw'
    	var mymap = L.map('mapid','mapbox.streets').setView([46.7984, 8.231879], 8);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.streets',
        renderer: L.svg(),
        accessToken: 'pk.eyJ1IjoiZHJrYWxybWFyeHgiLCJhIjoiY2poeGl3NXc3MGI2dzNxcHV1eHh2OGh4ZyJ9.9VnqOY3kY8Rid8FUFb2Okw',
    }).addTo(mymap);
		// Make a reusable color scale array
		var colorRange = [ 'green', 'yellow', 'red' ];
		// Create the legend to illustrate the color scale being divergent

    function onLocationFound(e) {
    var radius = e.accuracy / 2;

    L.marker(e.latlng).addTo(mymap)
        .bindPopup("You are within " + radius + " meters from this point");

    L.circle(e.latlng, radius).addTo(mymap);

    $.get('/api/P1/'+String(e.longitude)+'/'+String(e.latitude)+'/getClosestSensorData', function(result){
            //onSuccess
            $('#pName').text(result['name'])
            $('#pPM10Value').text(result['data']+' \u03BC'+'g/m3')
            $('#pDistance').text(result['distance']+' m')
    });

    $.get('/api/P2/'+String(e.longitude)+'/'+String(e.latitude)+'/getClosestSensorData', function(result){
            //onSuccess
            $('#pPM25Value').text(result['data']+' \u03BC'+'g/m3')
    });
}

mymap.on('locationfound', onLocationFound);

function onLocationError(e) {
    alert(e.message);
}

mymap.on('locationerror', onLocationError);

mymap.locate({setView: true, maxZoom: 8});

    var options = {

    radiusRange: [ 20, 30 ],
    radius: 30,
    radiusScaleExtent: [1,100],
    opacity: 0.5,
    duration: 500,
    colorRange: colorRange,
    colorScaleExtent: [0,100]
};
var sensorValueSelection = document.getElementById("sensor_value_selection");
function loadHexbin(d) {

        $.get('/api/'+d.value+'/getSensorData', function(result){
            //onSuccess

			var data = [];
			jQuery.each(result['data'], function(sensor) {
			   data.push([this.longitude, this.latitude,this.currentvalue,this.id]);


			});
			hexLayer.data(data);
        });


	}

    var hexLayer = L.hexbinLayer(options).addTo(mymap)
    hexLayer
  .radiusRange([20, 30])
	.lng(function(d) { return d[0]; })
  .lat(function(d) { return d[1]; })
  .colorValue(function(d){
                    return calculateMean(d);
                })
  .radiusValue(function(d) { return d.length*3; })
  .hoverHandler(L.HexbinHoverHandler.resizeFill());

	// Set up hover handler
	hexLayer.hoverHandler(L.HexbinHoverHandler.tooltip(function(d){
                    return calculateMean(d);}));

	hexLayer.dispatch()
		.on('mouseover', function(d, i) {setHovered(d);})
		.on('click', function(d, i) {
				showDataMulti(d);
			});

	var ctx = $("#myChart").get(0).getContext("2d");
	var config = {
		type: 'line',
		 data: '',
		 options: {
			responsive: true,
			title: {
				text: 'Chart.js Time Scale'
			},
			scales: {
				xAxes: [{
					type: 'time',
					display: true,
					scaleLabel: {
						display: false,
						labelString: 'Date'
					}
				}],
				yAxes: [{
					scaleLabel: {
						display: true,
						labelString: 'value'
					}
				}]
			},
		},
	}
	window.myLine=new Chart(ctx, config);




	function calculateMean(d) {
		var sum = 0;
		d.forEach(function (datum) {
				sum += datum.o[2];
			});
		var mean = sum / d.length;
		return mean;
		}

	function setHovered(d) {
		    d3.select('#hovered .count').text((null != d) ? calculateMean(d) : '');

		}
    var i=0;


	function showData(marker_id) {
        ajaxGet('/api/'+String(marker_id)+'/getSensorData', function(content){
            //onSuccess
            var ctx = $("#myChart").get(0).getContext("2d");
                new Chart(ctx, {
                    type: 'line', data: data
                });
            alert(content);
        })
        var a = 1;
        }

	function showDataMulti(d) {
		var urlIDs='';
		var timeFormat = 'YYYY-MM-DD HH:mm:ss';
		d.forEach(function (datum) {
				urlIDs+= String(datum.o[3])+'&';
			});
		urlIDs =  urlIDs.slice(0,-1);
        $.get('/api/'+sensorValueSelection.options[sensorValueSelection.selectedIndex].value+'/'+urlIDs+'/getSensorData', function(data){
            //onSuccess
			config.data = data;
			window.myLine.update();
        });
	}


	function showCluster(d) {

		var timeFormat = 'YYYY-MM-DD HH:mm:ss';

        $.get('/api/'+d.value+'/getClusterSensorData', function(data){
            //onSuccess
			configCluster.data = data;
			window.myLineCluster.update();
        });
	}




</script>

{% endblock %}

